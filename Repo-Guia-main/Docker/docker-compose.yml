# services:
#   sqlserver:
#     image: mcr.microsoft.com/mssql/server:2022-latest
#     container_name: mssqlserver-developer-edition
#     ports:
#       - "1433:1433"
#     environment:
#       - ACCEPT_EULA=${ACCEPT_EULA}
#       - MSSQL_PID=${MSSQL_PID}
#       - SA_PASSWORD=${SA_PASSWORD}
#     volumes:
#       - sql-data:/var/opt/mssql
#     restart: always

#   seq:
#     image: datalust/seq:latest
#     container_name: seq
#     restart: unless-stopped
#     environment:
#       ACCEPT_EULA: ${SEQ_ACCEPT_EULA}
#       SEQ_FIRSTRUN_NOAUTHENTICATION: ${SEQ_FIRSTRUN_NOAUTHENTICATION}
#       # Si quieres auth en Seq, descomenta esta:
#       # SEQ_PASSWORD: ${SEQ_PASSWORD}
#     volumes:
#       - seq-data:/data
#     ports:
#       - "5341:80"
#       - "5342:5341"

#   uptime-kuma:
#     image: louislam/uptime-kuma:2
#     container_name: uptime-kuma
#     restart: unless-stopped
#     ports:
#       - "3001:3001"   # UI
#     volumes:
#       - uptime-kuma-data:/app/data
#       - /var/run/docker.sock:/var/run/docker.sock   # â† acceso al socket de Docker


# volumes:
#   sql-data:
#   seq-data:
#     name: seq-data
#   uptime-kuma-data:

#--
services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: mssqlserver-developer-edition
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=${ACCEPT_EULA}
      - MSSQL_PID=${MSSQL_PID}
      - SA_PASSWORD=${SA_PASSWORD}
    volumes:
      - sql-data:/var/opt/mssql
    restart: always

  seq:
    image: datalust/seq:latest
    container_name: seq
    restart: unless-stopped
    environment:
      ACCEPT_EULA: ${SEQ_ACCEPT_EULA}
      SEQ_FIRSTRUN_NOAUTHENTICATION: ${SEQ_FIRSTRUN_NOAUTHENTICATION}
      #SEQ_PASSWORD: ${SEQ_PASSWORD}
    volumes:
      - seq-data:/data
    ports:
      - "5341:80"
      - "5342:5341"

  uptime-kuma:
    image: louislam/uptime-kuma:2
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "3001:3001"   # UI
    volumes:
      - uptime-kuma-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock

  # ðŸ”¹ Tu API .NET 8
  webapi:
    build:
      context: ..                       # desde Docker/ -> sube a Repo-Guia
      dockerfile: WebApi/Docker/Dockerfile
    container_name: project-webapi
    restart: unless-stopped

    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: "Server=sqlserver,1433;Database=TuDb;User ID=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;"

    depends_on:
    - sqlserver
    ports:
    - "8080:8080"

  # ðŸ”¹ Prometheus: scrapea /metrics de la API
  prometheus:
    build:
      context: .                       # raÃ­z: Repo-Guia
      dockerfile: Prometheus.Dockerfile
    container_name: prometheus
    restart: unless-stopped

    ports:
      - "9090:9090"   # UI de Prometheus
    depends_on:
      - webapi

  # ðŸ”¹ Grafana: visualizaciÃ³n
  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    restart: unless-stopped

    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    ports:
      - "3000:3000"   # http://localhost:3000
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  sql-data:
  seq-data:
    name: seq-data
  uptime-kuma-data:
  grafana-data:
